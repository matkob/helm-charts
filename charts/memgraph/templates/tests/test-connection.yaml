apiVersion: batch/v1
kind: Job
metadata:
  name: "{{ include "memgraph.fullname" . }}-test"
  labels:
    {{- include "memgraph.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
spec:
  template:
    spec:
      containers:
      - name: memgraph-test
        image: memgraph/memgraph:2.18.1
        command: ["/bin/sh", "-c"]
        args:
          - |
            echo "RETURN 0;" | mgconsole --username $MEMGRAPH_USER --password $MEMGRAPH_PASSWORD --host {{ include "memgraph.fullname" . }} --port 7687
        env:
          - name: MEMGRAPH_USER
            valueFrom:
              secretKeyRef:
                name: memgraph-secrets
                key: MEMGRAPH_USER
          - name: MEMGRAPH_PASSWORD
            valueFrom:
              secretKeyRef:
                name: memgraph-secrets
                key: MEMGRAPH_PASSWORD
      restartPolicy: Never
  backoffLimit: 4
